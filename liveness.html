<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Face Liveness Detection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family:sans-serif; text-align:center; background:#f5f5f5; }
    h2 { color:#3A6CAC; margin:20px 0; }
    .container { position:relative; display:inline-block; width:100%; max-width:420px; }
    #video { width:100%; border:3px solid #3A6CAC; border-radius:12px; }
    #statusBox {
      position:absolute;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.6);
      color:#fff;
      padding:10px 20px;
      border-radius:20px;
      font-size:16px;
      text-align:center;
      width:90%;
    }
    #progressBar {
      margin-top:6px;
      height:6px;
      width:100%;
      background:rgba(255,255,255,0.3);
      border-radius:3px;
      overflow:hidden;
    }
    #progressFill {
      height:100%;
      width:0%;
      background:#4caf50;
      transition:width 0.1s linear;
    }
    #startBtn {
      margin-top:15px;
      padding:10px 20px;
      font-size:16px;
      border:0;
      border-radius:6px;
      background:#3a6cac;
      color:#fff;
    }
  </style>
</head>
<body>
  <h2>Face Liveness Detection</h2>
  <div class="container">
    <video id="video" autoplay muted playsinline></video>
    <div id="statusBox">
      <div id="status">Click “Start Test”</div>
      <div id="progressBar"><div id="progressFill"></div></div>
    </div>
  </div>
  <br>
  <button id="startBtn">Start Test & Record</button>

  <script>
    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const progressFill = document.getElementById('progressFill');
    const startBtn = document.getElementById('startBtn');

    let recorder;
    let chunks = [];

    function getSupportedMimeType() {
      if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) return "";
      if (MediaRecorder.isTypeSupported("video/webm;codecs=vp9")) return "video/webm;codecs=vp9";
      if (MediaRecorder.isTypeSupported("video/webm;codecs=vp8")) return "video/webm;codecs=vp8";
      if (MediaRecorder.isTypeSupported("video/webm")) return "video/webm";
      if (MediaRecorder.isTypeSupported("video/mp4")) return "video/mp4";
      return "";
    }

function uploadVideo(blob) {
  statusEl.textContent = "正在传回父页面...";
  statusEl.style.color = "#ffeb3b";

  // 把视频转成 Base64
  const reader = new FileReader();
  reader.onloadend = function() {
    const base64 = reader.result; // data:video/webm;base64,xxxxx
    window.parent.postMessage({ type: "livenessVideoBase64", data: base64 }, "*");

    statusEl.textContent = "视频已回传 ✅";
    statusEl.style.color = "#4caf50";
  };
  reader.readAsDataURL(blob);
}

    function startRecording(stream) {
      const mimeType = getSupportedMimeType();
      recorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);

      recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: recorder.mimeType || "video/webm" });
        uploadVideo(blob);
      };

      recorder.start();
    }

    function runStep(text, duration=3000) {
      return new Promise(resolve => {
        statusEl.textContent = text;
        statusEl.style.color = "#fff";
        let elapsed = 0;
        progressFill.style.width = "0%";
        const step = 100;
        const timer = setInterval(() => {
          elapsed += step;
          const percent = Math.min(100, (elapsed / duration) * 100);
          progressFill.style.width = percent + "%";
          if (elapsed >= duration) {
            clearInterval(timer);
            resolve();
          }
        }, step);
      });
    }

    async function startTest() {
      await runStep("Please nod", 3000);
      await runStep("Please open your mouth", 3000);
      await runStep("Please blink", 3000);
      statusEl.textContent = "Finishing, sending video...";
      progressFill.style.width = "100%";
      recorder.stop();
    }

    startBtn.onclick = async () => {
      chunks = [];
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:"user" }, audio: true });
        video.srcObject = stream;
        startRecording(stream);
        startTest();
      } catch (err) {
        statusEl.textContent = "Camera error: " + err.message;
        statusEl.style.color = "red";
      }
    };
  </script>
</body>
</html>
