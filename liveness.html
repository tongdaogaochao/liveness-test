<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>人脸活体检测</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family: sans-serif; text-align:center; background:#f5f5f5; }
    .container { position: relative; display:inline-block; width:100%; max-width:420px; }
    #video { width:100%; border:1px solid #ccc; border-radius:8px; }
    #statusBox {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 16px;
      text-align: center;
      width: 80%;
      max-width: 300px;
    }
    #progressBar {
      margin-top:6px;
      height:6px;
      width:100%;
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
      overflow: hidden;
    }
    #progressFill {
      height:100%;
      width:0%;
      background: #4caf50;
      transition: width 0.1s linear;
    }
    #startBtn { margin-top:12px; padding:10px 20px; font-size:16px; border:0; border-radius:6px; background:#3a6cac; color:#fff; }
  </style>
</head>
<body>
  <h2>人脸活体检测</h2>
  <div class="container">
    <video id="video" autoplay muted playsinline></video>
    <div id="statusBox">
      <div id="status">请点击“开始检测”</div>
      <div id="progressBar"><div id="progressFill"></div></div>
    </div>
  </div>
  <br>
  <button id="startBtn">开始检测并录制</button>

  <script>
    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const progressFill = document.getElementById('progressFill');
    const startBtn = document.getElementById('startBtn');

    let recorder;
    let chunks = [];

    function startRecording(stream) {
      recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
      recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: "video/webm" });

        // 转成 Base64
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64data = reader.result.split(',')[1]; // 去掉 data:video/webm;base64,
          
          // 发送给父页面
          window.parent.postMessage({ 
            type: "livenessDone", 
            videoBase64: base64data 
          }, "*");

          statusEl.textContent = "视频已上传到页面";
        };
        reader.readAsDataURL(blob);
      };
      recorder.start();
    }

    function runStep(text, duration=3000) {
      return new Promise(resolve => {
        statusEl.textContent = text;
        let elapsed = 0;
        const step = 100;
        progressFill.style.width = "0%";

        const timer = setInterval(() => {
          elapsed += step;
          const percent = Math.min(100, (elapsed / duration) * 100);
          progressFill.style.width = percent + "%";
          if (elapsed >= duration) {
            clearInterval(timer);
            resolve();
          }
        }, step);
      });
    }

    async function startTest() {
      await runStep("请点头", 3000);
      await runStep("请张嘴", 3000);
      await runStep("请眨眼", 3000);
      statusEl.textContent = "检测完成，正在上传视频...";
      progressFill.style.width = "100%";
      recorder.stop();
    }

    startBtn.onclick = async () => {
      chunks = [];
      try {
        // 在点击事件里立即调用摄像头
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:"user" }, audio: true });
        video.srcObject = stream;

        // 开始录制
        startRecording(stream);

        // 开始动作检测
        startTest();
      } catch (err) {
        statusEl.textContent = "无法开启摄像头：" + err.message;
      }
    };
  </script>
</body>
</html>
