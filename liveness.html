<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>人脸活体检测</title>
  <style>
    body { margin:0; font-family: sans-serif; text-align:center; background:#f5f5f5; }
    #video { width:100%; max-width:420px; border:1px solid #ccc; border-radius:8px; }
    #status { margin:12px 0; font-size:16px; font-weight:bold; color:#333; }
    #startBtn { padding:10px 20px; font-size:16px; border:0; border-radius:6px; background:#3a6cac; color:#fff; }
  </style>
</head>
<body>
  <h2>人脸活体检测</h2>
  <video id="video" autoplay muted playsinline></video>
  <div id="status">请点击“开始检测”</div>
  <button id="startBtn">开始检测并录制</button>

  <script>
    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');

    let recorder;
    let chunks = [];

    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        video.srcObject = stream;
        return stream;
      } catch (err) {
        statusEl.textContent = "无法开启摄像头：" + err.message;
        throw err;
      }
    }

    function startRecording(stream) {
      recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
      recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);

        // 下载保存
        const a = document.createElement("a");
        a.href = url;
        a.download = "liveness.webm";
        a.click();

        // 传递给父页面（低代码平台）
        window.parent.postMessage({ type: "livenessDone", videoUrl: url }, "*");
      };
      recorder.start();
    }

    async function startTest() {
      statusEl.textContent = "请点头";
      await new Promise(r => setTimeout(r, 3000));
      statusEl.textContent = "请张嘴";
      await new Promise(r => setTimeout(r, 3000));
      statusEl.textContent = "请眨眼";
      await new Promise(r => setTimeout(r, 3000));
      statusEl.textContent = "检测完成，正在保存视频...";
      recorder.stop();
    }

    startBtn.onclick = async () => {
      chunks = [];
      const stream = await initCamera();
      startRecording(stream);
      startTest();
    };
  </script>
</body>
</html>
